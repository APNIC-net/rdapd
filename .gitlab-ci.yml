image: alpine:latest

variables:
  POSTGRES_USER: user
  POSTGRES_PASSWORD: testing-password
  POSTGRES_ENABLED: "true"
  POSTGRES_DB: $CI_ENVIRONMENT_SLUG
  KUBERNETES_VERSION: 1.9.1
  HELM_VERSION: 2.8.2
  CODECLIMATE_VERSION: 0.72.0
  HTTP_PROXY: ${HTTP_PROXY}
  HTTPS_PROXY: ${HTTPS_PROXY}
  NO_PROXY: ${NO_PROXY}

stages:
  - package
  - test
  - review
  - staging
  - canary
  - production
  - performance
  - cleanup

.build_test_docker_image:
  stage: package
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - build_and_push_docker_image
  only:
    - branches

.fake_build:
  variables:
    DOCKER_DRIVER: overlay2
    HTTP_PROXY: ${HTTP_PROXY}
    HTTPS_PROXY: ${HTTPS_PROXY}
    NO_PROXY: ${NO_PROXY}
  stage: test
  image: docker:stable
  allow_failure: true
  services:
    - name: $CI_REGISTRY/ci/dind:0.0.1
  script:
    - setup_docker
    - fake_build
  only:
    - branches

.unit_tests:
  stage: test
  image: maven:3.5-jdk-8-alpine
  script:
    - setup_maven
    - mvn test
  only:
    - branches

.publish_to_test:
  stage: test
  image: $CI_REGISTRY/ci/alpine-kubectl-helm:1.0.1
  script:
    - publish_chart tst
  only:
    - branches

.publish_to_prod:
  stage: production
  image: $CI_REGISTRY/ci/alpine-kubectl-helm:1.0.1
  script:
    - publish_chart prod
  when: manual

.codequality:
  variables:
    DOCKER_DRIVER: overlay2
    HTTP_PROXY: ${HTTP_PROXY}
    HTTPS_PROXY: ${HTTPS_PROXY}
    NO_PROXY: ${NO_PROXY}
  stage: test
  image: $CI_REGISTRY/docker:stable
  allow_failure: true
  services:
    - name: $CI_REGISTRY/ci/dind:0.0.1
  script:
    - setup_docker
    - code_quality
  artifacts:
    paths: [gl-code-quality-report.json]
  only:
    - branches
  except:
    variables:
      - $CODE_QUALITY_DISABLED

review:
  stage: review
  image: $CI_REGISTRY/ci/alpine-kubectl-helm:1.0.1
  variables:
    HTTP_PROXY: ${HTTP_PROXY}
    HTTPS_PROXY: ${HTTPS_PROXY}
    NO_PROXY: ${NO_PROXY}

  script:
    - export KUBE_NAMESPACE=${CI_PROJECT_NAME}-${CI_BUILD_REF_SLUG}
    - configure_cluster ${CI_PROJECT_NAME}-${CI_BUILD_REF_SLUG}
    - initialise_helm
    - ensure_namespace
    - create_secret
    - deploy
    - persist_environment_url
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: http://$CI_PROJECT_PATH_SLUG-$CI_ENVIRONMENT_SLUG.example.com/
    on_stop: cleanup
  artifacts:
    paths: [environment_url.html]
  only:
    refs:
      - branches
    kubernetes: active
  except:
    - master

cleanup:
  stage: cleanup
  image: alpine-kubectl-helm:1.0.0
  variables:
    GIT_STRATEGY: none
  script:
    - delete
  environment:
    name: review/$CI_COMMIT_REF_NAME
    action: stop
  when: manual
  allow_failure: true
  only:
    refs:
      - branches
    kubernetes: active
  except:
    - master
# ---------------------------------------------------------------------------

.auto_devops: &auto_devops |
  # Auto DevOps variables and functions
  [[ "$TRACE" ]] && set -x
  auto_database_url=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${CI_ENVIRONMENT_SLUG}-postgres:5432/${POSTGRES_DB}
  export DATABASE_URL=${DATABASE_URL-$auto_database_url}
  export CI_APPLICATION_REPOSITORY=$CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG
  export CI_APPLICATION_TAG=$CI_PIPELINE_ID.$CI_COMMIT_SHA
  export CI_CONTAINER_NAME=ci_job_build_${CI_JOB_ID}
  export KUBE_NAMESPACE=${CI_PROJECT_NAME}-${CI_BUILD_REF_SLUG}
  export TILLER_NAMESPACE='tiller'

  function code_quality() {
  echo $DOCKER_CONFIG
  docker run --env SOURCE_CODE="$(pwd)" \
          --env HTTP_PROXY=$HTTP_PROXY \
          --env HTTPS_PROXY=$HTTPS_PROXY \
          --env NO_PROXY=$NO_PROXY \
          --volume $(pwd):/code \
          --volume /var/run/docker.sock:/var/run/docker.sock \
          "acr2.tst.apnic.net/alex/codequality:0.0.3" /code
  }

  function deploy() {
    track="${1-stable}"
    name="$CI_ENVIRONMENT_SLUG"

    if [[ "$track" != "stable" ]]; then
      name="$name-$track"
    fi

    replicas="1"
    service_enabled="false"
    postgres_enabled="$POSTGRES_ENABLED"
    # canary uses stable db
    [[ "$track" == "canary" ]] && postgres_enabled="false"

    env_track=$( echo $track | tr -s  '[:lower:]'  '[:upper:]' )
    env_slug=$( echo ${CI_ENVIRONMENT_SLUG//-/_} | tr -s  '[:lower:]'  '[:upper:]' )

    if [[ "$track" == "stable" ]]; then
      # for stable track get number of replicas from `PRODUCTION_REPLICAS`
      eval new_replicas=\$${env_slug}_REPLICAS
      service_enabled="true"
    else
      # for all tracks get number of replicas from `CANARY_PRODUCTION_REPLICAS`
      eval new_replicas=\$${env_track}_${env_slug}_REPLICAS
    fi
    if [[ -n "$new_replicas" ]]; then
      replicas="$new_replicas"
    fi

    test_name="$(test_dep_name $name)"

    export CI_ENVIRONMENT_URL=$TEST_CLUSTER_SERVER/api/v1/namespaces/$KUBE_NAMESPACE/services/$name:8080/proxy/
    echo $CI_ENVIRONMENT_URL
    return
    echo "Starting test chart install"

    if [[ -n $(helm ls -q "^$test_name$") ]]; then
      echo "helm delete --purge \"$test_name\""
      helm delete --purge "$test_name"
      echo "$test_name deleted"
    fi
    helm upgrade --install \
      --tiller-namespace=$TILLER_NAMESPACE \
      --force \
      --wait \
      --namespace="$KUBE_NAMESPACE" \
      --version="$CI_PIPELINE_ID-$CI_JOB_ID" \
      $test_name \
      helm/test/

    echo "Starting rdapd chart install"

    if [[ -n $(helm ls -q "^$name$") ]]; then
      echo "helm delete --purge \"$name\""
      helm delete --purge "$name" &>/dev/null
      echo "$name deleted"
    fi

    echo "helm upgrade --install --tiller-namespace=$TILLER_NAMESPACE --force --wait --set service.enabled=\"$service_enabled\" --set releaseOverride=\"$CI_ENVIRONMENT_SLUG\" --set image.repository=\"$CI_REGISTRY/$CI_REGISTRY_PATH/$CI_COMMIT_REF_SLUG\" --set image.tag=\"$CI_APPLICATION_TAG\" --set image.pullPolicy=IfNotPresent --set application.track=\"$track\" --set application.database_url=\"$DATABASE_URL\" --set service.url=\"$CI_ENVIRONMENT_URL\" --set replicaCount=\"$replicas\" --set postgresql.enabled=\"$postgres_enabled\" --set postgresql.nameOverride=\"postgres\" --set postgresql.postgresUser=\"$POSTGRES_USER\" --set postgresql.postgresPassword=\"$POSTGRES_PASSWORD\" --set postgresql.postgresDatabase=\"$POSTGRES_DB\" --namespace=\"$KUBE_NAMESPACE\" --version=\"$CI_PIPELINE_ID-$CI_JOB_ID\" --values=helm/test-env-values.yaml \"$name\" helm/rdapd/"

    helm upgrade --install \
      --tiller-namespace=$TILLER_NAMESPACE \
      --force \
      --wait \
      --set service.enabled="$service_enabled" \
      --set releaseOverride="$CI_ENVIRONMENT_SLUG" \
      --set image.repository="$CI_REGISTRY/$CI_REGISTRY_PATH/$CI_COMMIT_REF_SLUG" \
      --set image.tag="$CI_APPLICATION_TAG" \
      --set image.pullPolicy=IfNotPresent \
      --set application.track="$track" \
      --set application.database_url="$DATABASE_URL" \
      --set service.url="$CI_ENVIRONMENT_URL" \
      --set replicaCount="$replicas" \
      --set postgresql.enabled="$postgres_enabled" \
      --set postgresql.nameOverride="postgres" \
      --set postgresql.postgresUser="$POSTGRES_USER" \
      --set postgresql.postgresPassword="$POSTGRES_PASSWORD" \
      --set postgresql.postgresDatabase="$POSTGRES_DB" \
      --set service.type="ExternalName" \
      --set service.externalName="my.alex.example.com" \
      --namespace="$KUBE_NAMESPACE" \
      --version="$CI_PIPELINE_ID-$CI_JOB_ID" \
      --values=helm/test-env-values.yaml \
      "$name" \
      helm/rdapd/
  }

  function configure_cluster() {
    echo "Configuring cluster"
    echo $TEST_CLUSTER_CA_BUNDLE > test_cluster_ca.crt
    kubectl config set-cluster --kubeconfig=ci ci --server=$TEST_CLUSTER_SERVER --insecure-skip-tls-verify=true
    kubectl config set-context  --kubeconfig=ci ci --namespace=$1 --cluster=ci --user=ci
    kubectl config set-credentials --kubeconfig=ci ci --token=$KUBE_TOKEN
    kubectl config use-context --kubeconfig=ci ci
    export  KUBECONFIG=ci
  }

  function test_dep_name() {
    local name=$1
    echo "$name-test-env"
  }

  function get_name(){
      track="${1-stable}"
      echo "Track: $track"
      local name="$CI_ENVIRONMENT_SLUG"

      if [[ "$track" != "stable" ]]; then
        name="$name-$track"
      fi
      echo $name
  }

  function setup_docker() {
    if ! docker info &>/dev/null; then
      if [ -z "$DOCKER_HOST" -a "$KUBERNETES_PORT" ]; then
        export DOCKER_HOST='tcp://localhost:2375'
      fi
    fi
    docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  }

  function setup_maven() {
    export MAVEN_MIRROR_OF=$MAVEN_MIRROR_OF
    export MAVEN_MIRROR_URL=$MAVEN_MIRROR_URL
    mkdir /root/.m2/
    cp maven_settings.xml /root/.m2/settings.xml
  }

  function initialise_helm() {
    chart_dir=helm/rdapd
    helm init --client-only --skip-refresh
    helm dependency update "$chart_dir/"
    helm dependency build "$chart_dir/"
  }

  function ensure_namespace() {
    kubectl describe namespace "$KUBE_NAMESPACE" || kubectl create namespace "$KUBE_NAMESPACE"
  }

  function fake_build() {
    docker pull acr2.tst.apnic.net/rdap/rdapd/ci-tests:1942.3ad6a0224f645d708c6f433ed62ac99f8a084d19
    docker tag acr2.tst.apnic.net/rdap/rdapd/ci-tests:1942.3ad6a0224f645d708c6f433ed62ac99f8a084d19 $CI_REGISTRY/$CI_REGISTRY_PATH/$CI_COMMIT_REF_SLUG:$CI_APPLICATION_TAG
    docker push $CI_REGISTRY/$CI_REGISTRY_PATH/$CI_COMMIT_REF_SLUG:$CI_APPLICATION_TAG
  }

  function build_and_push_docker_image() {
    echo "Creating and pusing docker image $CI_REGISTRY/$CI_REGISTRY_PATH/$CI_COMMIT_REF_SLUG:$CI_APPLICATION_TAG"
    echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    cat registry.crt  >> /kaniko/ssl/certs/ca-certificates.crt
    /kaniko/executor --context $CI_PROJECT_DIR --build-arg MAVEN_MIRROR_OF=$MAVEN_MIRROR_OF \
    --build-arg MAVEN_MIRROR_URL=$MAVEN_MIRROR_URL --build-arg HTTP_PROXY=$HTTP_PROXY \
    --build-arg HTTPS_PROXY=$HTTPS_PROXY --build-arg NO_PROXY=$NO_PROXY \
    --dockerfile $CI_PROJECT_DIR/Dockerfile \
    --destination $CI_REGISTRY/$CI_REGISTRY_PATH/$CI_COMMIT_REF_SLUG:$CI_APPLICATION_TAG
  }

  #Takes one argument: the chart museum server (tst or prd)
  function publish_chart() {
    mkdir /root/helm_package/
    helm package -d /root/helm_package/ helm/rdapd
    cd /root/helm_package
    echo "curl -s --data-binary \"@$(ls -A1 /root/helm_package/)\" $CHART_API_URI/api/$1/charts"
    curl -s --data-binary "@$(ls -A1 /root/helm_package/)" $CHART_API_URI/api/$1/charts
  }

  function create_secret() {
    echo "Create secret..."

    kubectl create secret -n "$KUBE_NAMESPACE" \
      docker-registry gitlab-registry \
      --docker-server="$CI_REGISTRY" \
      --docker-username="$CI_REGISTRY_USER" \
      --docker-password="$CI_REGISTRY_PASSWORD" \
      --docker-email="$GITLAB_USER_EMAIL" \
      -o yaml --dry-run | kubectl replace -n "$KUBE_NAMESPACE" --force -f -
  }

  function performance() {
    export CI_ENVIRONMENT_URL=$(cat environment_url.txt)

    mkdir gitlab-exporter
    wget -O gitlab-exporter/index.js https://gitlab.com/gitlab-org/gl-performance/raw/10-3/index.js

    mkdir sitespeed-results

    if [ -f .gitlab-urls.txt ]
    then
      sed -i -e 's@^@'"$CI_ENVIRONMENT_URL"'@' .gitlab-urls.txt
      docker run --shm-size=1g --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io:6.0.3 --plugins.add ./gitlab-exporter --outputFolder sitespeed-results .gitlab-urls.txt
    else
      docker run --shm-size=1g --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io:6.0.3 --plugins.add ./gitlab-exporter --outputFolder sitespeed-results "$CI_ENVIRONMENT_URL"
    fi

    mv sitespeed-results/data/performance.json performance.json
  }

  function persist_environment_url() {
    echo "persist_environment_url"
    echo $CI_ENVIRONMENT_URL > environment_url.html
  }

  function delete() {
    track="${1-stable}"
    name="$CI_ENVIRONMENT_SLUG"

    if [[ "$track" != "stable" ]]; then
      name="$name-$track"
    fi

    if [[ -n "$(helm ls -q "^$name$")" ]]; then
      helm delete --purge "$name"
      helm delete --purge "$(test_dep_name $name)"
    fi
  }

before_script:
  - *auto_devops
